---
title: "SI-Quant_FullAnalysis"
author: "Rose Schneider"
date: "11/14/2016"
output: html_document
---

Full and updated analysis for Horowitz, Schneider, & Frank (under review). Codebase is being updated to streamline and consolidate in advance of and prep for submission. All updated code is validated against the original output.

#Preliminaries
```{r setup, include=FALSE}
rm(list=ls())
library(knitr)
opts_chunk$set(cache=FALSE, message=FALSE, warning=FALSE, error=FALSE)  
```

```{r}
library(ggplot2)
library(reshape)
library(plyr)
library(dplyr)
library(stringr)
library(tidyr)
library(markdown)
library(directlabels)
library(magrittr)
library(langcog)
library(diptest)
library(lme4)
theme_set(theme_bw())

setwd("~/Documents/Projects/si_paper/analyses/analysis/")
```

#Experiment 1

##Data management
```{r}
data_exp1_raw <- read.csv("../data/implicatures_adhocScalar_data.csv")

#fill in the selection types for easier analyses
d_exp1=melt.data.frame(data_exp1_raw,c("Subj_ID", "age","agegroup", "gender"),c("carrots", "hats", "cookies", "trains", "cats", "purses",  "keys", "shirts", "breads", "horses", "bears", "frogs", "plates", "books", "elephants", "lamps", "bananas", "butterflies", 
"carrots_condition", "hats_condition", "cookies_condition", "trains_condition", "cats_condition", "purses_condition",  "keys_condition", "shirts_condition", "breads_condition", "horses_condition", "bears_condition", "frogs_condition", "plates_condition", "books_condition", "elephants_condition", "lamps_condition", "bananas_condition", "butterflies_condition",
"carrots_selection", "hats_selection", "cookies_selection", "trains_selection", "cats_selection", "purses_selection",  "keys_selection", "shirts_selection", "breads_selection", "horses_selection", "bears_selection", "frogs_selection", "plates_selection", "books_selection", "elephants_selection", "lamps_selection", "bananas_selection", "butterflies_selection",
"carrots_target", "hats_target", "cookies_target", "trains_target", "cats_target", "purses_target",  "keys_target", "shirts_target", "breads_target", "horses_target", "bears_target", "frogs_target", "plates_target", "books_target", "elephants_target", "lamps_target", "bananas_target", "butterflies_target",
"carrots_type", "hats_type", "cookies_type", "trains_type", "cats_type", "purses_type",  "keys_type", "shirts_type", "breads_type", "horses_type", "bears_type", "frogs_type", "plates_type", "books_type", "elephants_type", "lamps_type", "bananas_type", "butterflies_type"))

data_exp1 <- d_exp1[1:864,] 
data_exp1$condition <- d_exp1$value[865:1728]
data_exp1$selection <- d_exp1$value[1729:2592]
data_exp1$target <- d_exp1$value[2593:3456]
data_exp1$type <- d_exp1$value[3457:4320]
names(data_exp1)[5] <- "item"
names(data_exp1)[6] <- "correct"

#some tidying
data_exp1 %<>%
  mutate(trial_type = ifelse(type == "implicature", "Implicature", "Control")) %>%
  mutate(type = factor(type, levels = c("implicature","control_comparison","control_distractor",
					      "control_none","control_unambiguous", "control_all"), 
				    	  labels = c("Implicature","Comparison","Distractor","None","Unambig. Some", "All")),
         condition = factor(condition, levels = c("adhoc", "scalar"), 
                            labels = c("Ad hoc", "Scalar")))

#quick sanity check to make sure there's nothing incorrectly coded
data_exp1_check <- data_exp1 %>%
  filter(target == selection & correct == 0)

#two coding errors
#101314_04 - participant points to 2nd book, which is "some"
data_exp1 %<>%
  mutate(correct = ifelse(Subj_ID == "101314_04" & item == "frogs", 1, correct))

#110714_01 chose 'some' - change this to correct
data_exp1 %<>%
  mutate(correct = ifelse(Subj_ID == "110714_01" & item == "books", 1, correct))

#check again to make sure everything is correct
data_exp1_check <- data_exp1 %>%
  filter(target == selection & correct == 0)

if (length(data_exp1_check$Subj_ID) != 0) {
  print("ERROR: Check and make sure all data correctly coded")
} else {
  print("All data correctly coded")
}
``` 

##Classify trials as first or second half
```{r}
data_exp1$item <- as.character(data_exp1$item)
first_half <- c("carrots", "hats", "cookies", "trains", "cats", "purses",  "keys", "shirts", "breads")

data_exp1$half <- ifelse(data_exp1$item %in% first_half, "first", "second")
data_exp1$item <- factor(data_exp1$item)
```
    
##Demographic information          
```{r}
exp1_demo <- data_exp1 %>%
  distinct(agegroup, Subj_ID, gender, age)%>%
  group_by(agegroup) %>%
  summarise(n = n(), 
            n_female = sum(gender == "f"), 
            n_male = sum(gender == "m"), 
            mean_age = round(mean(age), 2), 
            median_age = round(median(age), 2), 
            sd_age = round(sd(age), 2))
```

##Mean performance across conditions, by agegroup
```{r}
ms_exp1 <- data_exp1 %>%
  mutate(correct = as.numeric(correct))%>%
  group_by(condition, type, trial_type, agegroup)%>%
  multi_boot_standard("correct", na.rm = TRUE)

pdf(file="./exp1_performance.pdf", width=6.5, height=4)
p <- ggplot(data = ms_exp1,aes(x=type, y=mean, fill=type, alpha=agegroup)) + 
  geom_bar(stat="identity", position = position_dodge()) +
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .3,
                  show.legend = FALSE,
                 position=position_dodge(width = 0.9)) +
  theme_bw(base_size = 10) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_alpha_manual(values=c(0.8, 1), 
                     guide = guide_legend(title = "Age group (years)")) + 
  labs(x = "Trial Type", y = "Mean Correct") +
  scale_fill_solarized() +
facet_grid(~condition, scale = "free_x") + guides(fill = FALSE)
print(p)
aux <- dev.off()
```

###T-tests of performance across trial types and age groups

```{r}
t_test_exp1 <- data_exp1 %>%
  filter(condition == "Scalar")%>%
  mutate(correct = as.numeric(correct))

t_test_exp1 <- aggregate(correct ~ type + agegroup +  Subj_ID, data=t_test_exp1, mean)
```


###T-tests: Age-groups, by trial type, scalar condition only
```{r}
#t-tests against "all"
#4-4.5
#all-some
t.test(subset(t_test_exp1, agegroup == "4.0--4.5" & type == "All")$correct,
       subset(t_test_exp1, agegroup == "4.0--4.5" & type == "Implicature")$correct,
       var.equal = TRUE)
#all-none
t.test(subset(t_test_exp1, agegroup == "4.0--4.5" & type == "All")$correct,
       subset(t_test_exp1, agegroup == "4.0--4.5" & type == "None")$correct,
       var.equal = TRUE)
#all-unambig.some
t.test(subset(t_test_exp1, agegroup == "4.0--4.5" & type == "All")$correct,
       subset(t_test_exp1, agegroup == "4.0--4.5" & type == "Unambig. Some")$correct,
       var.equal = TRUE)

#4.5-5
#all-some
t.test(subset(t_test_exp1, agegroup == "4.5--5.0" & type == "All")$correct,
       subset(t_test_exp1, agegroup == "4.5--5.0" & type == "Implicature")$correct,
       var.equal = TRUE)
#all-none
t.test(subset(t_test_exp1, agegroup == "4.5--5.0" & type == "All")$correct,
       subset(t_test_exp1, agegroup == "4.5--5.0" & type == "None")$correct,
       var.equal = TRUE)
#all-unambig.some
t.test(subset(t_test_exp1, agegroup == "4.5--5.0" & type == "All")$correct,
       subset(t_test_exp1, agegroup == "4.5--5.0" & type == "Unambig. Some")$correct,
       var.equal = TRUE)

#SI between ages
t.test(subset(t_test_exp1, agegroup == "4.0--4.5" & type == "Implicature")$correct,
       subset(t_test_exp1, agegroup == "4.5--5.0" & type == "Implicature")$correct,
       var.equal = TRUE)
```

###T-tests: Scalar vs. ad hoc
T-tests: Scalar vs. ad-hoc
```{r}
t_test_exp1_2 <- data_exp1 %>%
  mutate(correct = as.numeric(correct))

t_test_exp1_2 <- aggregate(correct ~ type + agegroup + condition + Subj_ID, data=t_test_exp1_2, mean)

#comparison - ad-hoc implicature vs. scalar
#4-4.5
t.test(subset(t_test_exp1_2, agegroup == "4.0--4.5" & type == "Implicature" 
              & condition == "Ad hoc")$correct,
       subset(t_test_exp1_2, agegroup == "4.0--4.5" & type == "Implicature" 
              & condition == "Scalar")$correct,
       var.equal = TRUE)

#4.5-5
t.test(subset(t_test_exp1_2, agegroup == "4.5--5.0" & type == "Implicature" 
              & condition == "Ad hoc")$correct,
       subset(t_test_exp1_2, agegroup == "4.5--5.0" & type == "Implicature" 
              & condition == "Scalar")$correct,
       var.equal = TRUE)
```

###Diptest for bimodal performance
```{r}
dip_exp1 <- data_exp1 %>%
  group_by(type, condition, Subj_ID) %>%
  mutate(correct = as.numeric(correct)) %>%
  summarise(mean = mean(correct), 
            agegroup = agegroup[1]) %>%
  filter(condition == "Scalar")

dip_df_exp1 <- cast(dip_exp1, Subj_ID + agegroup ~ type + condition, value="mean") %>%
  rename(control_none_scalar = None_Scalar, 
         implicature_scalar = Implicature_Scalar, control_all_scalar = All_Scalar)

dip.test(dip_df_exp1$implicature_scalar)
dip.test(dip_df_exp1$control_none_scalar)
dip.test(dip_df_exp1$control_all_scalar)
```

####Graph of bimodal distribution
```{r}
exp1_hist <- data_exp1 %>%
  filter(condition == "Scalar" & type != "All" & type != "Unambig. Some")%>%
  group_by(Subj_ID, type)%>%
  mutate(correct = as.numeric(correct))%>%
  multi_boot_standard("correct", na.rm = TRUE)

pdf(file="./exp1_hist.pdf", width=6, height=3.5)
q <- ggplot(exp1_hist, aes(x = mean, fill=type)) + 
  geom_histogram(colour = "black", stat = "bin",breaks = c(0,.2,.4,.6,.8,1), binwidth = .2) + 
  theme_bw(base_size = 18) + 
  xlab("Mean performance") + 
  ylab("Frequency") + 
  facet_wrap(~type) + 
  theme_bw(base_size = 10) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        legend.position = "none") +
  scale_fill_solarized() + 
  scale_x_continuous(breaks = c(0,.2,.4,.6,.8,1))
print(q)
aux <- dev.off()
```

###Full correlations
```{r}
#full correlations
cor.test(dip_df_exp1$control_none_scalar, dip_df_exp1$implicature_scalar)
cor.test(dip_df_exp1$control_all_scalar, dip_df_exp1$implicature_scalar)
cor.test(dip_df_exp1$control_none_scalar, dip_df_exp1$control_all_scalar)

#by age
#none-some
cs %>% group_by(agegroup) %>% 
	summarise(r = cor.test(control_none_scalar, implicature_scalar)$estimate,
			  p = cor.test(control_none_scalar, implicature_scalar)$p.value)
#all-some
cor.test(cs$control_all_scalar, cs$implicature_scalar)
cs %>% group_by(agegroup) %>% 
	summarise(r = cor.test(control_all_scalar, implicature_scalar)$estimate,
			  p = cor.test(control_all_scalar, implicature_scalar)$p.value)
#all-none
cor.test(cs$control_all_scalar, cs$control_none_scalar)
cs %>% group_by(agegroup) %>% 
	summarise(r = cor.test(control_all_scalar, control_none_scalar)$estimate,
			  p = cor.test(control_all_scalar, control_none_scalar)$p.value)	
```
  
###Logistic regression
```{r}
#center age to facilitate model fit
data_exp1 %<>%
  mutate(age.c = as.vector(scale(age, center = TRUE, scale=FALSE)))%>%
  mutate(correct = as.integer(correct))

gl <- glmer(correct ~ trial_type * condition * age.c  + 
              (trial_type | Subj_ID), data=data_exp1, 
            family=binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

lm <- glmer(correct ~ trial_type * condition * age.c +
              (trial_type| Subj_ID) + (trial_type|item), 
            data = data_exp1, family = binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

summary(lm)
summary(gl)

#is half of experiment significant?
gl_half <- glmer(correct ~ trial_type * condition * age.c * half + 
              (trial_type | Subj_ID), data=data_exp1, 
            family=binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

summary(gl_half)
```
  
#Experiment 2

##Read in data
```{r}
d2 <- read.csv("../data/implicatures_scalarOnly_data.csv")

data_exp2=melt.data.frame(d2,c("Subj_ID","age","agegroup","gender", "ethnicity"),c("carrots", "hats", "cookies", "trains", "cats", "purses",  "keys", "shirts", "breads", "horses", "bears", "frogs", "plates", "books", "elephants", "lamps", "bananas", "butterflies", 
"carrots_selectionType", "hats_selectionType", "cookies_selectionType", "trains_selectionType", "cats_selectionType", "purses_selectionType",  "keys_selectionType", "shirts_selectionType", "breads_selectionType", "horses_selectionType", "bears_selectionType", "frogs_selectionType", "plates_selectionType", "books_selectionType", "elephants_selectionType", "lamps_selectionType", "bananas_selectionType", "butterflies_selectionType", 
"carrots_type", "hats_type", "cookies_type", "trains_type", "cats_type", "purses_type",  "keys_type", "shirts_type", "breads_type", "horses_type", "bears_type", "frogs_type", "plates_type", "books_type", "elephants_type", "lamps_type", "bananas_type", "butterflies_type"))

data <- data_exp2[1:918,] 
data$selectionType <- data_exp2$value[919:1836]
data$type <- data_exp2$value[1837:2754]
names(data)[4] <- "gender"
names(data)[5] <-"ethnicity"
names(data)[6] <- "item"
names(data)[7] <- "correct"

data_exp2 <- data

data_exp2 %<>%
  mutate(type = factor(type, levels = c("all","some","none"), 
				    	  labels = c("All","Some","None")),
         selectionType = factor(selectionType, levels = c("all", "some", "none"), 
                            labels = c("All", "Some", "None")), 
         correct = as.numeric(correct))

attach(data_exp2)
data_exp2$trial_type[type == "some"] <- "implicature"
data_exp2$trial_type[type != "some"] <- "control"
detach(data_exp2)

#is there incorrectly coded data?
exp2_check <- data_exp2 %>%
  filter(selectionType == type & correct == 0)

#6 coding errors - these were checked on original videos of trials
#112014_4 points to 2 book, which is the 'some' book, so change to correct
data_exp2 %<>%
  mutate(correct = ifelse(Subj_ID == "112014_04" & item == "hats", 1, correct))

#120514_07 has 5 coding errors - these were checked on original videos of trials
#trial 6 - picked 'all'
#trial 8 - picked 'some'
#trial 11 - picked 'all'
#trial 14 - picked 'all'
#trial 17 - picked 'all'
data_exp2 %<>%
  mutate(correct = ifelse(Subj_ID == "120514_07" & item == "shirts", 1, correct))

#also need to fix selection type for incorrectly coded items
data_exp2 %<>%
  mutate(selectionType = ifelse(Subj_ID == "120514_07" & item == "purses", 1, selectionType))%>%
  mutate(selectionType = ifelse(Subj_ID == "120514_07" & item == "horses", 1, selectionType))%>% 
  mutate(selectionType = ifelse(Subj_ID == "120514_07" & item == "plates", 1, selectionType))%>% 
  mutate(selectionType = ifelse(Subj_ID == "120514_07" & item == "bananas", 1, selectionType))

#fix factoring from correcting selections
data_exp2 %<>%
  mutate(selectionType = factor(selectionType, levels = c(1, 2, 3), labels = c("All", "Some", "None")))

#check again, throw an error in there are issues
exp2_check <- data_exp2 %>%
  filter(selectionType == type & correct == 0)

if (length(exp2_check$Subj_ID) != 0) {
  print("ERROR: Data are not correctly coded")
} else {
  print("Data are correctly coded")
}
```

##Classify trials as first or second half
```{r}
data_exp2$item <- as.character(data_exp2$item)
first_half <- c("carrots", "hats", "cookies", "trains", "cats", "purses",  "keys", "shirts", "breads")

data_exp2$half <- ifelse(data_exp2$item %in% first_half, "first", "second")
data_exp2$item <- factor(data_exp2$item)
```
    

###Demographic information
```{r}
demo_exp2 <- data_exp2 %>%
  distinct(agegroup, age, gender, ethnicity, Subj_ID)%>%
  group_by(agegroup)%>%
  summarise(n = n(), 
            n_female = sum(gender == "f"), 
            n_male = sum(gender == "m"), 
            mean_age = round(mean(age), 2), 
            median_age = round(median(age), 2), 
            sd_age = round(sd(age), 2))

#for some reason can no longer filter by factor?
demo_ethnicity_2 <- data_exp2 %>%
  distinct(agegroup, age, gender, ethnicity, Subj_ID)%>%
  group_by(ethnicity)%>%
  summarise(n = n())

```

##Mean performance by trial and age group
```{r}
ms_exp2 <- data_exp2 %>%
  group_by(type, agegroup)%>%
  multi_boot_standard("correct", na.rm=T)

pdf(file="./exp2_performance.pdf", width=6, height=3.5)
p <- 
quartz()
ggplot(data = ms_exp2, aes(x=type, y=mean, fill=type, alpha=agegroup)) + 
  geom_bar(stat="identity", position = position_dodge()) +
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .3,
                  show.legend = FALSE,
                 position=position_dodge(width = 0.9)) +
  theme_bw(base_size = 10) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_alpha_manual(values=c(0.5,.625, .725, 1), 
                     guide = guide_legend(title = "Age group (years)")) + 
  labs(x = "Trial Type", y = "Mean Correct") +
  scale_fill_solarized() + guides(fill = FALSE)
print(p)
aux <- dev.off()
```
  
###T-tests by trial type and age group
```{r}
t_test_exp2 <- data_exp2 %>%
  mutate(correct = as.numeric(as.character(correct)))

t_test_exp2  <- aggregate(correct ~ type + agegroup +Subj_ID, data=t_test_exp2 , mean)

#tests between quantifiers
#all and some
t.test(subset(t_test_exp2, agegroup=="3.0--3.5" & type=="All")$correct, 
       subset(t_test_exp2, agegroup=="3.0--3.5" & type=="Some")$correct, 
       var.equal = TRUE)
t.test(subset(t_test_exp2, agegroup=="3.5--4.0" & type=="All")$correct, 
       subset(t_test_exp2, agegroup=="3.5--4.0"& type=="Some")$correct, 
       var.equal = TRUE)
t.test(subset(t_test_exp2, agegroup=="4.0--4.5" & type=="All")$correct, 
       subset(t_test_exp2, agegroup=="4.0--4.5" & type=="Some")$correct, 
       var.equal = TRUE)
t.test(subset(t_test_exp2, agegroup=="4.5--5.0" & type=="All")$correct, 
       subset(t_test_exp2, agegroup=="4.5--5.0" & type=="Some")$correct, 
       var.equal = TRUE)

#all and none
t.test(subset(t_test_exp2, agegroup=="3.0--3.5" & type=="All")$correct, 
       subset(t_test_exp2, agegroup=="3.0--3.5" & type=="None")$correct, 
       var.equal = TRUE)
t.test(subset(t_test_exp2, agegroup=="3.5--4.0" & type=="All")$correct, 
       subset(t_test_exp2, agegroup=="3.5--4.0" & type=="None")$correct, 
       var.equal = TRUE)
t.test(subset(t_test_exp2, agegroup=="4.0--4.5" & type=="All")$correct, 
       subset(t_test_exp2, agegroup=="4.0--4.5" & type=="None")$correct, 
       var.equal = TRUE)
t.test(subset(t_test_exp2, agegroup=="4.5--5.0" & type=="All")$correct, 
       subset(t_test_exp2, agegroup=="4.5--5.0" & type=="None")$correct, 
       var.equal = TRUE)
```

###T-tests between exp 1 and exp. 2
```{r}
exp1_ms <- data_exp1 %>%
  filter(condition == "Scalar")%>%
  mutate(correct = as.numeric(correct))
exp2_ms <- data_exp2%>%
  mutate(correct = as.numeric(correct))

t_test_exp1 <- aggregate(correct ~ type + agegroup +  Subj_ID, data=exp1_ms, mean)%>%
  spread(type, correct)
t_test_exp2 <- aggregate(correct ~ type + agegroup +  Subj_ID, data=exp2_ms, mean)%>%
  spread(type, correct)

#4-4.5s
t.test(subset(t_test_exp1, agegroup == "4.0--4.5")$All, subset(t_test_exp2, agegroup == "4.0--4.5")$All, 
       var.equal = TRUE)
t.test(subset(t_test_exp1, agegroup == "4.0--4.5")$Implicature, subset(t_test_exp2, agegroup == "4.0--4.5")$Some, 
       var.equal = TRUE)
t.test(subset(t_test_exp1, agegroup == "4.0--4.5")$None, subset(t_test_exp2, agegroup == "4.0--4.5")$None, 
       var.equal = TRUE)

#4.5-5
t.test(subset(t_test_exp1, agegroup == "4.5--5.0")$All, subset(t_test_exp2, agegroup == "4.5--5.0")$All, 
       var.equal = TRUE)
t.test(subset(t_test_exp1, agegroup == "4.5--5.0")$Implicature, subset(t_test_exp2, agegroup == "4.5--5.0")$Some, 
       var.equal = TRUE)
t.test(subset(t_test_exp1, agegroup == "4.5--5.0")$None, subset(t_test_exp2, agegroup == "4.5--5.0")$None, 
       var.equal = TRUE)
```

##Diptests and bimodal distribution
```{r}
dip_ms_exp2 <- data_exp2 %>%
  group_by(type, Subj_ID)%>%
  mutate(agegroup = agegroup[1]) %>%
  summarise(mean = mean(correct),
            agegroup = agegroup[1])

dip_exp2 <- cast(dip_ms_exp2, Subj_ID + agegroup ~ type, value="mean")

dip.test(dip_exp2$Some)
dip.test(dip_exp2$None)
dip.test(dip_exp2$All)
```

##Incorrect selection 
```{r}
exp2_wrong <- data_exp2 %>%
  filter(correct != 1) %>%
  group_by(agegroup, type, selectionType)%>%
  dplyr::summarise(n=n())%>%
  mutate(n.total = sum(n), prop = n/n.total)
    
#now graph
pdf(file="./exp2_wrong.pdf", width=6, height=3.5)
p <- ggplot(data = exp2_wrong, 
       aes(x=selectionType, y=n, fill=selectionType, alpha=agegroup)) +
  geom_bar(stat="identity", position = position_dodge())  +
  ylab("Count of children choosing") + 
  xlab("Selection Type") + facet_wrap(~type) + 
  theme_bw(base_size=10) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_alpha_manual(values=c(.5,.625,.725,1)) + guides(fill = FALSE) +
  scale_fill_solarized() + scale_alpha_manual(values=c(0.5,.625, .725, 1), 
                     guide = guide_legend(title = "Age group (years)")) + 
  labs(x = "Trial Type", y = "Mean Correct")
print(p)
aux <- dev.off()
```

##Correlations (full)

```{r}
cor.test(dip_exp2$Some, dip_exp2$None)

dip_exp2 %>% group_by(agegroup) %>% 
	summarise(r = cor.test(None, Some)$estimate,
			  p = cor.test(None, Some)$p.value)
```

##Logistic regression
```{r}
data_exp2 %<>%
  mutate(age.c = scale(age, center=TRUE, scale=FALSE))

gl.int <- glmer(correct ~  type * age.c 
			+ (type | Subj_ID), 
			data=data_exp2, family=binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
summary(gl.int)

gl.half <- glmer(correct ~  type * age.c * half
			+ (type | Subj_ID), 
			data=data_exp2, family=binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
summary(gl.half)

gl.norand <- glmer(correct ~  type * age.c 
			+ (1 | Subj_ID), 
			data=data_exp2, family=binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
summary(gl.norand)
```

#Experiment 3 - Scalar Implicature main analyses
##Read in data - Scalar Implicature
```{r}
#reading in the original wide-form dataframe
d3 <- read.csv("../data/SI_coding.csv")

#fill in the selection types for easier analyses
d3 %<>%
  mutate(carrot_selection = factor(carrot_selection, levels=c(1, 2, 3), labels = c("none", "some", "all")), 
         hat_selection = factor(hat_selection, levels=c(1, 2, 3), labels = c("all", "some", "none")), 
         cookies_selection = factor(cookies_selection, levels=c(1, 2, 3), labels = c("none", "some", "all")),
         trains_selection = factor(trains_selection, levels=c(1, 2, 3), labels = c("none", "all", "some")), 
         cats_selection = factor(cats_selection, levels=c(1, 2, 3), labels = c("all", "some", "none")),
         purses_selection = factor(purses_selection, levels=c(1, 2, 3), labels = c("none", "some", "all")),
         keys_selection = factor(keys_selection, levels=c(1, 2, 3), labels = c("none", "some", "all")),
         shirts_selection = factor(shirts_selection, levels=c(1, 2, 3), labels = c("some", "all", "none")),
         breads_selection = factor(breads_selection, levels=c(1, 2, 3), labels = c("all", "some", "none")), 
         horses_selection = factor(horses_selection, levels=c(1, 2, 3), labels = c("all", "some", "none")), 
         bears_selection= factor(bears_selection, levels=c(1, 2, 3), labels = c("none", "some", "all")),
         frogs_selection = factor(frogs_selection, levels=c(1, 2, 3), labels = c("all", "some", "none")), 
         plates_selection = factor(plates_selection, levels=c(1, 2, 3), labels = c("all", "some", "none")), 
         books_selection = factor(books_selection, levels=c(1, 2, 3), labels = c("none", "all", "some")), 
         elephants_selection = factor(elephants_selection, levels=c(1, 2, 3), labels = c("some", "all", "none")),
         lamps_selection = factor(lamps_selection, levels=c(1, 2, 3), labels = c("none", "all", "some")), 
         bananas_selection = factor(bananas_selection, levels=c(1, 2, 3), labels = c("some", "all", "none")), 
         butterflies_selection = factor(butterflies_selection, levels=c(1, 2, 3), labels = c("none", "some", "all")))

d2=melt.data.frame(d3,c("sub_ID","test_age", "agegroup","ethnicity", "gender"),c("carrot", "hat", "cookies", "trains", "cats", "purses",  "keys", "shirts", "breads", "horses", "bears", "frogs", "plates", "books", "elephants", "lamps", "bananas", "butterflies", "carrot_selection", "hat_selection", "cookies_selection", "trains_selection", "cats_selection", "purses_selection",  "keys_selection", "shirts_selection", "breads_selection", "horses_selection", "bears_selection", "frogs_selection", "plates_selection", "books_selection", "elephants_selection", "lamps_selection", "bananas_selection", "butterflies_selection", "carrot_type", "hat_type", "cookies_type", "trains_type", "cats_type", "purses_type",  "keys_type", "shirts_type", "breads_type", "horses_type", "bears_type", "frogs_type", "plates_type", "books_type", "elephants_type", "lamps_type", "bananas_type", "butterflies_type"))


#making a respectable df  
onethird <- (1/3)*nrow(d2)
data <- d2[1:onethird,]
data$selection <- d2$value[(onethird+1):(onethird*2)]
data$type <- d2$value[(2*onethird+1):nrow(d2)]
names(data)[6] <- "item"
names(data)[7] <- "SI_correct"
data$correct <- data$SI_correct==1

#filtering out NAs, adding agesplit
data %<>%
  filter(sub_ID != "", correct != "NA")%>%
  mutate(agegroup = factor(agegroup, levels = c("3-3.5 years", "3.5-4 years", "4-4.5 years", "4.5-5 years"), 
                           labels = c("3.0--3.5", "3.5--4.0", "4.0--4.5", "4.5--5.0")), 
         selection = factor(selection, levels = c("all", "some", "none"), 
                            labels = c("All", "Some", "None")), 
         type = factor(type, levels = c("control_all", "implicature", "control_none"), 
                       labels = c("All", "Some", "None")), 
         SI_correct = as.numeric(SI_correct),
         test = "Scalar Implicature")

data_si <- data

##sanity check! 
si_check <- data_si %>%
  filter(selection == type & SI_correct == 0)

if (length(si_check$sub_ID) != 0) {
  print("ERROR: Data are incorrectly coded")
}
```

###Demographic information
```{r}
#Find the Mean and median ages
exp3_demo <- data_si %>%
  distinct(agegroup, test_age, gender, ethnicity, sub_ID)%>%
  group_by(agegroup)%>%
  summarise(n = n(), 
            n_female = sum(gender == "F"), 
            n_male = sum(gender == "M"), 
            mean_age = round(mean(test_age), 2), 
            median_age = round(median(test_age), 2), 
            sd_age = round(sd(test_age), 2))

exp3_ethnicity <- data_si %>%
  distinct(agegroup, sub_ID, ethnicity)%>%
  group_by(ethnicity)%>%
  summarise(n = n())


#use this dataframe for stats
data_si <- data %>%
  mutate(test = "Scalar Implicature")
```

##Mean performance by trial type and age
```{r}
ms_exp3 <- data_si %>%
  group_by(type, agegroup)%>%
  multi_boot_standard("correct", na.rm=T)


#plot
pdf(file="./exp3_SIperformance.pdf", width=6, height=3.5)
p <- ggplot(data = ms_exp3, aes(x=type, y=mean, fill=type, alpha=agegroup)) + 
  geom_bar(stat="identity", position = position_dodge()) +
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .3,
                  show.legend = FALSE,
                 position=position_dodge(width = 0.9)) +
  theme_bw(base_size = 10) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_alpha_manual(values=c(0.5,.625, .725, 1), 
                     guide = guide_legend(title = "Age group (years)")) + 
  labs(x = "Trial Type", y = "Mean Correct") +
  scale_fill_solarized() + guides(fill = FALSE)
aux <- dev.off()
```

##T-tests
###Testing against Ali's original data
```{r}
#first create a df 
#aggregate correct repsonses 
ms_exp2 <- aggregate(correct ~ type + agegroup +  Subj_ID, data=data_exp2, mean)%>%
  spread(type, correct)
ms_exp3 <- aggregate(correct ~ type + agegroup +  sub_ID, data=data_si, mean)%>%
  spread(type, correct)

#tests across age groups
#3-3.5
t.test(subset(ms_exp2, agegroup == "3.0--3.5")$All, subset(ms_exp3, agegroup == "3.0--3.5")$All, 
       var.equal = TRUE)
t.test(subset(ms_exp2, agegroup == "3.0--3.5")$Some, subset(ms_exp3, agegroup == "3.0--3.5")$Some, 
       var.equal = TRUE)
t.test(subset(ms_exp2, agegroup == "3.0--3.5")$None, subset(ms_exp3, agegroup == "3.0--3.5")$None, 
       var.equal = TRUE)

#3.5-4
t.test(subset(ms_exp2, agegroup == "3.5--4.0")$All, subset(ms_exp3, agegroup == "3.5--4.0")$All, 
       var.equal = TRUE)
t.test(subset(ms_exp2, agegroup == "3.5--4.0")$Some, subset(ms_exp3, agegroup == "3.5--4.0")$Some, 
       var.equal = TRUE)
t.test(subset(ms_exp2, agegroup == "3.5--4.0")$None, subset(ms_exp3, agegroup == "3.5--4.0")$None, 
       var.equal = TRUE)

#4-4.5
t.test(subset(ms_exp2, agegroup == "4.0--4.5")$All, subset(ms_exp3, agegroup == "4.0--4.5")$All, 
       var.equal = TRUE)
t.test(subset(ms_exp2, agegroup == "4.0--4.5")$Some, subset(ms_exp3, agegroup == "4.0--4.5")$Some, 
       var.equal = TRUE)
t.test(subset(ms_exp2, agegroup == "4.0--4.5")$None, subset(ms_exp3, agegroup == "4.0--4.5")$None, 
       var.equal = TRUE)

#4.5-5
t.test(subset(ms_exp2, agegroup == "4.5--5.0")$All, subset(ms_exp3, agegroup == "4.5--5.0")$All, 
       var.equal = TRUE)
t.test(subset(ms_exp2, agegroup == "4.5--5.0")$Some, subset(ms_exp3, agegroup == "4.5--5.0")$Some, 
       var.equal = TRUE)
t.test(subset(ms_exp2, agegroup == "4.5--5.0")$None, subset(ms_exp3, agegroup == "4.5--5.0")$None, 
       var.equal = TRUE)
```

###T-tests across trial types within agegroups with exp 3 data
```{r}
d <- data_si 

d <- aggregate(correct ~ type + agegroup +sub_ID, data=d, mean)

#tests between quantifiers
#all and some
t.test(subset(d, agegroup=="3.0--3.5" & type=="All")$correct, 
       subset(d, agegroup=="3.0--3.5" & type=="Some")$correct, 
       var.equal = TRUE)
t.test(subset(d, agegroup=="3.5--4.0" & type=="All")$correct, 
       subset(d, agegroup=="3.5--4.0"& type=="Some")$correct, 
       var.equal = TRUE)
t.test(subset(d, agegroup=="4.0--4.5" & type=="All")$correct, 
       subset(d, agegroup=="4.0--4.5" & type=="Some")$correct, 
       var.equal = TRUE)
t.test(subset(d, agegroup=="4.5--5.0" & type=="All")$correct, 
       subset(d, agegroup=="4.5--5.0" & type=="Some")$correct, 
       var.equal = TRUE)

#all and none
t.test(subset(d, agegroup=="3.0--3.5" & type=="All")$correct, 
       subset(d, agegroup=="3.0--3.5" & type=="None")$correct, 
       var.equal = TRUE)
t.test(subset(d, agegroup=="3.5--4.0" & type=="All")$correct, 
       subset(d, agegroup=="3.5--4.0" & type=="None")$correct, 
       var.equal = TRUE)
t.test(subset(d, agegroup=="4.0--4.5" & type=="All")$correct, 
       subset(d, agegroup=="4.0--4.5" & type=="None")$correct, 
       var.equal = TRUE)
t.test(subset(d, agegroup=="4.5--5.0" & type=="All")$correct, 
       subset(d, agegroup=="4.5--5.0" & type=="None")$correct, 
       var.equal = TRUE)
```

##Diptest for bimodal performance
```{r}
dip_ms_exp3 <- data_si %>%
  group_by(type, sub_ID) %>%
  summarise(mean = mean(correct), 
            agegroup = agegroup[1], 
            age = test_age[1])

dip_exp3 <- cast(dip_ms_exp3, sub_ID + agegroup + age ~ type, value="mean")

dip.test(dip_exp3$Some)
dip.test(dip_exp3$None)
dip.test(dip_exp3$All)
```

##Correlations (full)
```{r}
cor.test(dip_exp3$Some, dip_exp3$None)

cs %>% group_by(agegroup) %>% 
	summarise(r = cor.test(None, Some)$estimate,
			  p = cor.test(None, Some)$p.value)
```
##Correlation (partial, controlling for age)
```{r}
library(ppcor)
pcor.test(dip_exp3$Some, dip_exp3$None, dip_exp3$age)
```

##Incorrect selections 
```{r}
si_wrong <- data_si %>%
  filter(correct != "TRUE") %>%
  group_by(agegroup, type, selection)%>%
  dplyr::summarise(n=n())%>%
  mutate(n.total = sum(n), prop = n/n.total)

pdf(file="./exp3_SIwrong.pdf", width=6, height=3.5)
p <- ggplot(data = si_wrong, 
       aes(x=selection, y=n, fill=selection, alpha=agegroup)) +
  geom_bar(stat="identity", position = position_dodge())  +
  ylab("Count of children choosing") + 
  xlab("Selection Type") + facet_wrap(~type) + 
  theme_bw(base_size=10) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_alpha_manual(values=c(.5,.625,.725,1)) + guides(fill = FALSE) +
  scale_fill_solarized() + scale_alpha_manual(values=c(0.5,.625, .725, 1), 
                     guide = guide_legend(title = "Age group (years)")) + 
  labs(x = "Trial Type", y = "Count of children choosing")
print(p)
aux <- dev.off()
```  

#Experiment 3 - Give-Quantifier full analyses
```{r}
#read in and establish dataframe
data_gq_raw <- read.csv("../data/GQ_coding.csv")
data_gq_raw[,c(8,10,12,14,16,18,20,22, 31, 32, 33, 34)] <- sapply(data_gq_raw[,c(8,10,12,14,16,18,20,22, 31, 32, 33, 34)],as.character) #for unknown reasons this is necessary for melt.data.frame now

#change to long form
d2=melt.data.frame(data_gq_raw,c("sub_ID", "test_age","agegroup", "condition", "training"),c("X1_condition", "X2_condition", "X3_condition", "X4_condition", "X5_condition", "X6_condition",  "X7_condition", "X8_condition", "X1_given", "X2_given", "X3_given", "X4_given", "X5_given", "X6_given",  "X7_given", "X8_given", "X1_correct", "X2_correct", "X3_correct", "X4_correct", "X5_correct", "X6_correct",  "X7_correct", "X8_correct"))

#making a respectable df  
onethird <- (1/3)*nrow(d2)
data <- d2[1:onethird,]
data$selection <- d2$value[(onethird+1):(onethird*2)]
data$type <- d2$value[(2*onethird+1):nrow(d2)]
names(data)[6] <- "trial"
names(data)[7] <- "prompt"
names(data)[8] <- "num_given"
names(data)[9] <- "GQ_correct"

#filtering data, creating age breaks
data %<>%
  filter(sub_ID != "", num_given != "N/A")%>%
  mutate(num_given = as.numeric(as.character(num_given)), 
         GQ_correct = as.numeric(as.character(GQ_correct)), 
         test = "Give-Quantifier", 
         agegroup = factor(agegroup, levels = c("3-3.5 years", "3.5-4 years", "4-4.5 years", "4.5-5 years"), 
                           labels = c("3.0--3.5", "3.5--4.0", "4.0--4.5", "4.5--5.0")), 
         prompt = factor(prompt, levels = c("all", "some", "none", "most"), 
                            labels = c("All", "Some", "None", "Most")))

data_gq <- data

#sanity check - is this coded correctly
data_gq$check <- ifelse((data_gq$prompt == "Most" & 4 < data_gq$num_given & data_gq$num_given < 8  |
                           data_gq$prompt == "All" & data_gq$num_given == 8 |
                           data_gq$prompt == "Some" & 1 < data_gq$num_given & data_gq$num_given < 8 |
                           data_gq$prompt == "None" & data_gq$num_given == 0), 1, 0)

gq_check <- data_gq %>%
  filter(GQ_correct != check)

#some coding errors - fix these
data_gq %<>%
  mutate(GQ_correct = ifelse(num_given == 8 & prompt == "Most", 0, GQ_correct))

#test for coding errors
gq_check <- data_gq %>%
  filter(GQ_correct != check)

if (length(gq_check$sub_ID) != 0) {
  print("ERROR: Data are incorrectly coded")
}
```

##Mean correct by age and trial type 
"Correct" responses outlined in Barner, Chow, & Yang (2009).
```{r}
ms_gq <- data_gq %>%
  filter(prompt != "Most") %>%
  group_by(prompt, agegroup)%>%
  multi_boot_standard("GQ_correct", na.rm=T)

pdf(file="./exp3_GQperf.pdf", width=6, height=3.5)
p <- quartz()
ggplot(data = ms_gq, 
       aes(x=prompt, y=mean, fill=prompt, alpha = `agegroup`)) +
  geom_bar(stat="identity", position = position_dodge()) +
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .3,
                  show.legend = FALSE,
                 position=position_dodge(width = 0.9)) +
  ylab("Proportion correct") + 
  xlab("Quantifier Prompt") +
  theme_bw(base_size=18) + 
  theme(axis.title.x = element_text(size=16),
        axis.title.y  = element_text(size=16),
        legend.title=element_text(size=14), 
        legend.text=element_text(size=14), 
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) +
  scale_alpha_manual(values=c(.5,.625,.725,1), 
                     guide = guide_legend(title = "Age group (years)")) + guides(fill = FALSE) +
  scale_fill_solarized()
print(p)
aux <- dev.off()
```

##Histogram of mean items given by age and prompt
```{r}
hist_data <- data_gq %>%
  filter(prompt != "Most")%>%
  group_by(agegroup, prompt, num_given)%>%
  dplyr::summarise(n = n()) %>%
  dplyr::group_by(agegroup, prompt) %>%
  mutate(n.total = 36, prop = n/n.total)

#unclear why "group_by" isn't working in this second instance here; hardcoded until I debug

pdf(file="./exp3_GQhist.pdf", width=6, height=4)
p <- ggplot(data = hist_data, 
       aes(x=num_given, y=prop, fill=prompt, alpha = agegroup)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.9)) +
  ylab("Proportion of children giving number") + 
  xlab("Number of items") +
  theme_bw(base_size=10) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_alpha_manual(values=c(.5,.625,.75,1)) + 
  guides(fill = FALSE) + 
  facet_grid(prompt~agegroup) + 
  theme(legend.position="none") + 
  scale_fill_solarized()
print(p)
aux <- dev.off()
```

#Experiment 3 - DCCS
```{r}
data_dccs_raw <- read.csv("../data/DCCS_coding.csv")
#long form
d2=melt.data.frame(data_dccs_raw,c("sub_ID","test_age", "agegroup", "condition"),c("pre_1", "pre_2", "pre_3", "pre_4", "pre_5", "pre_6",  "post_1", "post_2", "post_3", "post_4", "post_5", "post_6"))

#filtering data, creating age breaks
data <- d2 %>%
  filter(sub_ID != "") 

#renaming things
names(data)[5] <- "trial_type"
names(data)[6] <- "DCCS_correct"

#df for further analyses
data_dccs <- data
data_dccs$test <- "DCCS"
  
#rename trials
tmp1 <- unlist(data$trial_type)%>%
  str_replace("pre_1", "pre")%>%
  str_replace("pre_2", "pre")%>%
  str_replace("pre_3", "pre")%>%
  str_replace("pre_4", "pre")%>%
  str_replace("pre_5", "pre")%>%
  str_replace("pre_6", "pre")%>%
  str_replace("post_1", "post")%>%
  str_replace("post_2", "post")%>%
  str_replace("post_3", "post")%>%
  str_replace("post_4", "post")%>%
  str_replace("post_5", "post")%>%
  str_replace("post_6", "post")

tmp <- as.data.frame(tmp1) %>%
  dplyr::rename(switch_type = tmp1)
tmp2 <- bind_cols(data, tmp)
data <- tmp2

#renaming for prettier graphs
data$switch_type %<>%
  str_replace("post", "Post-switch")%>%
  str_replace("pre", "Pre-switch")

data$switch_type <- as.factor(data$switch_type)
data_dccs <- data
```

##Mean correct across age group for post-switch trials
```{r}
ms.dccs <- data_dccs %>%
  mutate(DCCS_correct = as.integer(DCCS_correct)) %>%
  group_by(switch_type, agegroup)%>%
  filter(switch_type == "Post-switch")%>%
  multi_boot_standard("DCCS_correct", na.rm=T)
  


pdf(file="./exp3_DCCS.pdf", width=4, height=4)
p <- ggplot(data = ms.dccs, 
       aes(x=switch_type, y=mean, fill = switch_type, alpha = agegroup)) +
  geom_bar(stat="identity", position = position_dodge()) +
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .3,
                  show.legend = FALSE,
                 position=position_dodge(width = 0.9)) +
  ylab("Proportion correct") + 
  xlab("Trial Type") +
  theme_bw(base_size=10) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_fill_solarized() + 
  scale_alpha_manual(values=c(.5,.625,.725,1), 
                     guide = guide_legend(title = "Age group (years)")) + geom_hline(yintercept = .5, linetype = "dashed")
print(p)
aux <- dev.off()
```

##Full analyses
First, create long-form dataframe for group analyses
```{r}
#si df
data_si$SI_correct <- as.character(data_si$SI_correct)
data_si$SI_correct <- as.numeric(data_si$SI_correct)

#scalar implicature task
mss.si <- data_si %>%
  group_by(sub_ID, type)%>%
  dplyr::summarise(mean = mean(SI_correct), 
                   test_age = test_age[1],
                   agegroup = agegroup[1])%>%
  spread(type, mean)%>%
  dplyr::rename(SI_All = All, 
         SI_Some = Some, 
         SI_None = None)

#dccs
mss.dccs <- data_dccs %>%
  group_by(sub_ID, switch_type)%>%
  dplyr::summarise(mean=mean(DCCS_correct))%>%
  spread(switch_type, mean)
  

#now gq
#first mean number
mss.gq.mean <- data_gq %>%
  group_by(sub_ID, prompt)%>%
  dplyr::summarise(mean_num = mean(num_given)) %>%
  spread(prompt, mean_num)%>%
  dplyr::rename(GQ_All_mean = All, 
                GQ_Some_mean = Some, 
                GQ_None_mean = None, 
                GQ_Most_mean = Most)

#then correct
mss.gq.corr <- data_gq %>%
  group_by(sub_ID, prompt)%>%
  dplyr::summarise(mean_correct = mean(GQ_correct))%>%
  spread(prompt, mean_correct)%>%
  dplyr::rename(GQ_All = All, 
                GQ_Some = Some, 
                GQ_None = None, 
                GQ_Most = Most)
  

#overall correct for GQ
mss.gq.over <- data_gq %>%
  group_by(sub_ID)%>%
  dplyr::summarise(mean_correct = mean(GQ_correct))%>%
  dplyr::rename(GQ_overall = mean_correct)

#overall correct for SI
mss.si.over <- data_si %>%
  group_by(sub_ID)%>%
  dplyr::summarise(SI_overall = mean(SI_correct))
  

#bind together
tmp <- right_join(mss.si, mss.dccs, by = "sub_ID")
tmp1 <- right_join(tmp, mss.gq.mean, by = "sub_ID") 
tmp2 <- right_join(tmp1, mss.gq.corr, by = "sub_ID")
tmp3 <- right_join(tmp2, mss.gq.over, by="sub_ID")
d_all <- right_join(tmp3, mss.si.over, by = "sub_ID") 

#center age for model fit
#d_all %<>%
  #mutate(age.c = scale(test_age, scale = FALSE, center = TRUE))
```

##Full correlations
SI
```{r}
cor.test(d_all$SI_All, d_all$SI_Some)
cor.test(d_all$SI_Some, d_all$SI_None)
cor.test(d_all$SI_All, d_all$SI_None)
```
GQ
```{r}
cor.test(d_all$GQ_All, d_all$GQ_Some)
cor.test(d_all$GQ_Some, d_all$GQ_None)
cor.test(d_all$GQ_All, d_all$GQ_None)
```

DCCS
```{r}
cor.test(d_all$`Post-switch`, d_all$`Pre-switch`)
```

SI-GQ
```{r}
#within quantifier
cor.test(d_all$SI_All, d_all$GQ_All)
cor.test(d_all$SI_Some, d_all$GQ_Some)
cor.test(d_all$SI_None, d_all$GQ_None)

#across quantifiers
cor.test(d_all$SI_All, d_all$GQ_None)
cor.test(d_all$SI_Some, d_all$GQ_All)
cor.test(d_all$SI_None, d_all$GQ_Some)
cor.test(d_all$SI_All, d_all$GQ_Some)
cor.test(d_all$SI_None, d_all$GQ_All)
```

DCCS-SI
```{r}
cor.test(d_all$SI_All, d_all$`Post-switch`)
cor.test(d_all$SI_Some, d_all$`Post-switch`)
cor.test(d_all$SI_None, d_all$`Post-switch`)
```

```{r}
#Significant correlation between age and DCCS
cor.test(~d_all$test_age + d_all$`Post-switch`)
#full correlation between some and none
cor.test(~d_all$SI_Some + d_all$SI_None)
```

Partial correlations for age - SI/GQ and DCCS
```{r}
library(ppcor)
#partial correlation - implicature and dccs
pcor.test(d_all$SI_Some, d_all$SI_None, d_all$test_age)

pcor.test(d_all$SI_Some, d_all$`Post-switch`, d_all$test_age)

pcor.test(d_all$SI_None, d_all$`Post-switch`, d_all$test_age)

pcor.test(d_all$SI_All, d_all$`Post-switch`, d_all$test_age)

pcor.test(d_all$GQ_None, d_all$`Post-switch`, d_all$test_age)

pcor.test(d_all$GQ_Some, d_all$`Post-switch`, d_all$test_age)

pcor.test(d_all$GQ_Most, d_all$`Post-switch`, d_all$test_age)

pcor.test(d_all$GQ_All, d_all$`Post-switch`, d_all$test_age)
```

GQ partial correlations
```{r}
pcor.test(d_all$GQ_Some, d_all$GQ_None, d_all$test_age)
```
SI and GQ partial correlations
```{r}
library(ppcor)
pcor.test(d_all$SI_Some, d_all$GQ_Some, d_all$test_age)

pcor.test(d_all$SI_Some, d_all$GQ_None, d_all$test_age)

pcor.test(d_all$SI_None, d_all$SI_Some, d_all$test_age)

pcor.test(d_all$SI_None, d_all$GQ_None, d_all$test_age)

pcor.test(d_all$SI_None, d_all$GQ_Some, d_all$test_age)
```

##T-tests
###DCCS
```{r}
df.dccs <- aggregate(DCCS_correct ~ switch_type + agegroup +  sub_ID, data=data_dccs, mean) 

t.test(subset(df.dccs, agegroup=="3-3.5 years" & switch_type=="Post-switch")$DCCS_correct, mu=0.5, 
       var.equal = TRUE)
t.test(subset(df.dccs, agegroup=="3.5-4 years" & switch_type=="Post-switch")$DCCS_correct, mu=0.5)
t.test(subset(df.dccs, agegroup=="4-4.5 years" & switch_type=="Post-switch")$DCCS_correct, mu=0.5, 
       var.equal = TRUE)
t.test(subset(df.dccs, agegroup=="4.5-5 years" & switch_type=="Post-switch")$DCCS_correct, mu=0.5)
```
  
##Diptests
```{r}
#scalar implicature
dip.test(d_all$SI_Some)
dip.test(d_all$SI_All)
dip.test(d_all$SI_None)

#GQ
dip.test(d_all$GQ_Some)
dip.test(d_all$GQ_None)
dip.test(d_all$GQ_All)

#break GQ down by age, see if a specific age group is driving this effect
young1 <- d_all%>%
  filter(agegroup == "3.0--3.5")

dip.test(young1$GQ_Some)
dip.test(young1$GQ_None)

young2 <- d_all%>%
  filter(agegroup == "3.5--4.0")

dip.test(young2$GQ_Some)
dip.test(young2$GQ_None)

old1 <- d_all %>%
  filter(agegroup == "4.0--4.5")

dip.test(old1$GQ_Some)
dip.test(old1$GQ_None)

old2 <- d_all %>%
  filter(agegroup == "4.5--5.0 years")
dip.test(old2$GQ_Some)
dip.test(old2$GQ_None)
```

#Experiment 4
```{r}
#reading in the original wide-form dataframe
data_exp4_raw <- read.csv("../data/si_paper_control.csv")

#fill in the selection types for easier analyses
data_exp4_raw %<>%
  mutate(carrot_selection = factor(carrot_selection, levels=c(1, 2, 3)), 
         hat_selection = factor(hat_selection, levels=c(1, 2, 3)),
         cat_selection = factor(cat_selection, levels=c(1, 2, 3)),
         purses_selection = factor(purses_selection, levels=c(1, 2, 3)),
         shirts_selection = factor(shirts_selection, levels=c(1, 2, 3)),
         horses_selection = factor(horses_selection, levels=c(1, 2, 3)), 
         bears_selection= factor(bears_selection, levels=c(1, 2, 3)),
         frogs_selection = factor(frogs_selection, levels=c(1, 2, 3)),
         plates_selection = factor(plates_selection, levels=c(1, 2, 3)),
         books_selection = factor(books_selection, levels=c(1, 2, 3)),
         elephants_selection = factor(elephants_selection, levels=c(1, 2, 3)),
         bananas_selection = factor(bananas_selection, levels=c(1, 2, 3)),
         carrot_correct = factor(carrot_correct, levels=c(0, 1)), 
         hat_correct = factor(hat_correct, levels=c(0, 1)),
         cat_correct = factor(cat_correct, levels=c(0, 1)),
         purses_correct = factor(purses_correct, levels=c(0, 1)),
         shirts_correct = factor(shirts_correct, levels=c(0, 1)),
         horses_correct = factor(horses_correct, levels=c(0, 1)), 
         bears_correct= factor(bears_correct, levels=c(0, 1)),
         frogs_correct = factor(frogs_correct, levels=c(0, 1)),
         plates_correct = factor(plates_correct, levels=c(0, 1)),
         books_correct = factor(books_correct, levels=c(0, 1)),
         elephants_correct = factor(elephants_correct, levels=c(0, 1)),
         bananas_correct = factor(bananas_correct, levels=c(0, 1)))

data=melt.data.frame(data_exp4_raw,c("SID","age", "agegroup","sex", "ethnicity", "Exclude"),c("carrot_prompt", "hat_prompt", "cat_prompt", "purses_prompt",  "shirts_prompt", "horses_prompt", "bears_prompt", "frogs_prompt", "plates_prompt", "books_prompt", "elephants_prompt", "bananas_prompt", "carrot_selection", "hat_selection", "cat_selection", "purses_selection",  "shirts_selection", "horses_selection", "bears_selection", "frogs_selection", "plates_selection", "books_selection", "elephants_selection", "bananas_selection", "carrot_selection_type", "hat_selection_type", "cat_selection_type", "purses_selection_type",  "shirts_selection_type", "horses_selection_type", "bears_selection_type", "frogs_selection_type", "plates_selection_type", "books_selection_type", "elephants_selection_type", "bananas_selection_type", "carrot_correct", "hat_correct", "cat_correct", "purses_correct",  "shirts_correct", "horses_correct", "bears_correct", "frogs_correct", "plates_correct", "books_correct", "elephants_correct", "bananas_correct"))


#making a respectable df  
onefourth <- (1/4)*nrow(data)
data1 <- data[1:onefourth,]
data1$prompt <- data$value[1:onefourth]
data1$selection <- data$value[(onefourth+1):(2*onefourth)]
data1$selection_type <- data$value[(2*onefourth+1):(3*onefourth)]
data1$correct <- data$value[(3*onefourth+1):(nrow(data))]
data1$correct_factor <- data1$correct==1

exp4 <- data1 %>%
  dplyr::select(SID, age, agegroup, sex, ethnicity, Exclude, prompt, selection, selection_type, correct, correct_factor)

exp4$selection_type %<>%
  str_replace("all", "All")%>%
  str_replace("some", "Some")

exp4$prompt %<>%
  str_replace("all", "All")%>%
  str_replace("some", "Some")
  
sum <- data_exp4_raw %>%
group_by(Exclude)%>%
distinct(SID)%>%
dplyr::summarise(n = n())

#filtering exclusions
exp4 %<>%
  filter(Exclude != 1)%>%
  filter(selection != "NaN")
  
#making correct a num for analysis
exp4 %<>%
  mutate(correct = as.numeric(correct_factor))

#check for coding errors
exp4_check <- exp4 %>%
  filter(prompt == selection_type & correct == 0)

#yes, so remove
exp4 %<>%
  filter(!(prompt == selection_type & correct == 0))

#check and test
exp4_check <- exp4 %>%
  filter(prompt == selection_type & correct == 0)

if (length(exp4_check$SID) != 0) {
  print("ERROR: Data are incorrectly coded")
}
  
```

Summary Statistics, general sanity checks
```{r}
#how many participants per age group?
exp4 %<>%
  mutate(ethnicity_simp = factor(ethnicity, levels = c("white", "whte", "black", "asian", "indian", 
                                                       "native hawaiian/pacific islander",
                                                       "", "american indian/alaskan native/asian", 
                                                       "american indian/alaskan native/white", 
                                                       "asian/white", "black/african american/white", 
                                                       "hispanic", "indian/french", "n/a"), 
                                 labels = c("white", "white", "black", "asian", "asian", 
                                            "other", "other", "mixed", "mixed", 
                                            "mixed", "mixed", "other", "mixed", "other")))

exp4_demo <- exp4 %>%
  distinct(agegroup, age, sex, ethnicity_simp, SID)%>%
  group_by(agegroup)%>%
  summarise(n = n(), 
            n_female = sum(sex == "F"), 
            n_male = sum(sex == "M"), 
            mean_age = round(mean(age), 2), 
            median_age = round(median(age), 2), 
            sd_age = round(sd(age), 2))

exp4_ethnicity <- exp4 %>%
  distinct(SID, ethnicity_simp)%>%
  group_by(ethnicity_simp)%>%
  summarise(n = n())
  
  
```  

##Mean correct by trial type and age
```{r}
#look at means
ms <- exp4 %>%
  group_by(prompt, agegroup) %>%
  multi_boot_standard("correct", na.rm=TRUE)

pdf(file="./exp4_SIperf.pdf", width=6, height=3.5)
p <- ggplot(data = ms, 
       aes(x=prompt, y=mean, fill=prompt, alpha = `agegroup`)) +
  geom_bar(stat="identity", position = position_dodge()) + 
   geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .3,
                  show.legend = FALSE,
                 position=position_dodge(width = 0.9)) +
  ylab("Mean Correct") + 
    xlab("Trial type") +
  theme_bw(base_size=10) + 
  theme(axis.title.x = element_text(size=14),
        axis.title.y  = element_text(size=14),
        legend.title=element_text(size=12), 
        legend.text=element_text(size=12), 
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) +
  scale_alpha_manual(values=c(.625, 1), 
                     guide = guide_legend(title = "Age group (years)")) + guides(fill = FALSE) +
  scale_fill_solarized()
print(p)
aux <- dev.off()
```  
  
incorrect selections  
```{r}  
#What kind of incorrect selections are children making? 
ms_wrong <- exp4 %>%
filter(correct_factor == FALSE)%>%
group_by(prompt, selection_type)%>%
  dplyr::summarise(n=n())

#how many total incorrect trials?
ms_tot.wrong <- exp4 %>%
  filter(correct_factor == FALSE)%>%
  summarise(n = n())
  
```  
  
Incorrect selection graph
```{r}
# ms_wrong$prompt %<>%
#   str_replace("none", "None")
# ms_wrong$selection_type %<>%
#   str_replace("none", "None")
# 
# ms_wrong %<>%
#   mutate(selection_type = factor(selection_type, levels = c("All", "Some", 
#                                                             "None")))
# 
# pdf(file="./exp4_SIwrong.pdf", width=6, height=3.5)
# p <- 
# ggplot(data = ms_wrong, 
#        aes(x=selection_type, y=n, fill=selection_type, alpha=agegroup)) +
#   geom_bar(stat="identity", position = position_dodge())  +
#   ylab("Count of children choosing") + 
#   xlab("Selection Type") + facet_wrap(~prompt) + 
#   theme_bw(base_size=10) + 
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank()) +
#   scale_alpha_manual(values=c(.5,.625,.725,1)) + guides(fill = FALSE) +
#   scale_fill_solarized() + scale_alpha_manual(values=c(.625,1), 
#                      guide = guide_legend(title = "Age group (years)")) + 
#   labs(x = "Trial Type", y = "Count of children choosing")
# print(p)
# aux <- dev.off()
```

##T-tests
```{r}
#difference in accuracy on either type of trial between age groups? #some
#create df for tests
 cs.exp4 <- aggregate(correct ~ prompt + agegroup + SID, data=exp4, mean)

t.test(subset(cs.exp4, prompt == "All" & agegroup == "4-4.5")$correct, subset(cs.exp4, prompt == "All" & agegroup == "4.5-5")$correct,
  var.equal = TRUE)
t.test(subset(cs.exp4, prompt == "Some" & agegroup == "4-4.5")$correct, subset(cs.exp4, prompt == "Some" & agegroup == "4.5-5")$correct, 
  var.equal = TRUE)
  
#no difference here, so we can collapse across age groups
t.test(subset(cs.exp4, prompt == "Some")$correct, subset(cs.exp4, prompt == "All")$correct, 
  var.equal = TRUE)
  
#t-test between old and control data
d_exp3 <- aggregate(SI_correct ~ type + agegroup + sub_ID, data = data_si, mean)

t.test(subset(d_exp3, type == "Some" & agegroup == "4.0--4.5")$SI_correct, subset(cs.exp4, prompt == "Some" & agegroup == "4-4.5")$correct, 
  var.equal = TRUE)

t.test(subset(d_exp3, type == "Some" & agegroup == "4.5--5.0")$SI_correct, subset(cs.exp4, prompt == "Some" & agegroup == "4.5-5")$correct, 
  var.equal = TRUE)
```

##Effect size
```{r}
cohens_d <- function(x, y) {
    lx <- length(x)- 1
    ly <- length(y)- 1
    md  <- abs(mean(x) - mean(y))        ## mean difference (numerator)
    csd <- lx * var(x) + ly * var(y)
    csd <- csd/(lx + ly)
    csd <- sqrt(csd)                     ## common sd computation

    cd  <- md/csd                        ## cohen's d
}

res <- cohens_d(subset(exp4,  prompt == "All")$correct, subset(exp4, prompt == "Some")$correct)
```

##Diptest
```{r}
mss <- ddply(exp4, .(prompt, SID), summarise, 
	mean = mean(correct),
  agegroup = agegroup[1])

cs <- cast(mss, SID + agegroup ~ prompt, value="mean") 

dip.test(cs$Some)
dip.test(cs$All)
```

#General linearized model
```{r}
exp4 %<>%
  mutate(age.c = scale(age, center=TRUE, scale=FALSE))

gl.int <- glmer(correct ~  prompt * age.c 
			+ (prompt | SID), 
			data=exp4, family=binomial, control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
summary(gl.int)

```